# m-security-scan - 综合安全扫描工作流

## 概述

`m-security-scan` 是一个全面的安全漏洞扫描和评估工作流，能够检查依赖项、代码、认证机制和数据处理流程中的安全问题。该命令支持不同扫描范围，从依赖项检查到全面的安全审计。

## 使用方法

```bash
/m-security-scan [scope]
```

## 参数详解

- `scope` (可选): 扫描范围
  - 默认行为: 扫描整个代码库
  - 支持范围:
    - `dependencies` - 仅扫描依赖项
    - `auth` - 专注于认证机制
    - `data-handling` - 数据处理安全
    - `full` - 全面安全评估
    - 特定路径: `src/api`, `config/` 等

## 使用示例

### 全面安全扫描
```bash
/m-security-scan
```
**预期结果**: 
- 扫描所有代码文件
- 检查依赖项漏洞
- 分析认证和授权
- 评估数据处理安全
- 生成综合安全报告

### 依赖项安全扫描
```bash
/m-security-scan dependencies
```
**预期结果**: 
- 检查 package.json/requirements.txt 等依赖文件
- 识别已知安全漏洞
- 检查过时的依赖项
- 提供更新建议

### 认证安全扫描
```bash
/m-security-scan auth
```
**预期结果**: 
- 分析认证机制实现
- 检查密码存储和验证
- 评估会话管理
- 审查权限控制

### 数据处理安全扫描
```bash
/m-security-scan data-handling
```
**预期结果**: 
- 检查输入验证
- 分析SQL注入风险
- 评估数据加密
- 审查敏感数据处理

### 特定目录扫描
```bash
/m-security-scan src/api
```
**预期结果**: 
- 扫描API相关代码
- 检查API安全实践
- 分析端点访问控制
- 评估数据传输安全

## 工作流程

### 1. 漏洞扫描
- **依赖项检查**: 使用安全数据库检查已知漏洞
- **代码静态分析**: 扫描代码中的安全问题
- **配置审查**: 检查配置文件中的安全设置
- **第三方库评估**: 分析第三方库的安全状况

### 2. 认证分析
- **认证机制审查**: 检查登录和认证流程
- **密码策略**: 评估密码存储和验证
- **会话管理**: 分析会话创建、维护和销毁
- **多因素认证**: 检查MFA实现

### 3. 数据处理检查
- **输入验证**: 检查用户输入的验证和清理
- **SQL注入防护**: 分析数据库查询的安全性
- **XSS防护**: 检查跨站脚本攻击防护
- **数据加密**: 评估敏感数据的加密处理

### 4. 安全报告生成
- **风险评级**: 按照CVSS标准评估风险等级
- **修复建议**: 提供具体的修复方案
- **优先级排序**: 根据风险程度排序
- **合规性检查**: 对照安全标准进行检查

### 5. 安全修复应用
- **自动修复**: 应用可安全自动修复的问题
- **手动修复指导**: 提供手动修复的详细步骤
- **配置更新**: 更新安全配置
- **依赖项更新**: 升级存在漏洞的依赖项

## 安全检查类别

### 依赖项安全
- **已知漏洞**: 检查CVE数据库
- **许可证问题**: 检查依赖项许可证
- **过时依赖**: 识别需要更新的依赖
- **恶意包**: 检查可疑的第三方包

### 代码安全
- **注入攻击**: SQL注入、命令注入、LDAP注入
- **跨站脚本**: XSS、CSRF攻击防护
- **访问控制**: 权限验证和授权检查
- **数据泄露**: 敏感信息泄露检查

### 配置安全
- **默认凭据**: 检查默认用户名密码
- **调试模式**: 生产环境调试配置
- **日志安全**: 敏感信息日志泄露
- **网络配置**: 端口、协议、加密设置

### 认证授权
- **弱密码**: 密码复杂度和存储
- **会话固定**: 会话劫持防护
- **权限提升**: 垂直和水平权限检查
- **令牌安全**: JWT、API密钥管理

## 预期结果

### 安全扫描报告
```
🔒 安全扫描报告
扫描时间: 2025-01-15 14:30:00
扫描范围: 全代码库
扫描文件: 234 个文件

📊 漏洞统计
  - 高风险: 2 个
  - 中风险: 5 个
  - 低风险: 12 个
  - 信息: 8 个

🚨 高风险漏洞
  1. SQL注入风险 (src/api/userController.js:45)
     - 描述: 用户输入未进行参数化查询
     - 风险: 数据库信息泄露
     - 修复: 使用参数化查询或ORM

  2. 硬编码密钥 (config/database.js:12)
     - 描述: 数据库密码硬编码在代码中
     - 风险: 凭据泄露
     - 修复: 使用环境变量或密钥管理服务

⚠️ 中风险漏洞
  1. 缺少CSRF防护 (src/middleware/auth.js)
  2. 会话超时配置过长 (config/session.js)
  3. 敏感信息日志记录 (src/utils/logger.js)
  4. 不安全的随机数生成 (src/utils/crypto.js)
  5. 缺少输入长度限制 (src/api/commentController.js)

🔧 修复建议
  1. 立即修复所有高风险漏洞
  2. 实施代码审查流程
  3. 添加安全测试到CI/CD
  4. 定期更新依赖项
  5. 启用安全头部配置
```

### 依赖项扫描结果
```
📦 依赖项安全扫描
检查的依赖项: 156 个

🚨 高风险依赖
  - lodash@4.17.15 (CVE-2021-23337)
    影响: 原型污染漏洞
    修复: 升级到 4.17.21+

  - express@4.16.4 (CVE-2022-24999)
    影响: 路径遍历漏洞
    修复: 升级到 4.17.3+

📋 修复命令
npm audit fix
npm install lodash@^4.17.21
npm install express@^4.17.3
```

### 认证安全评估
```
🔐 认证安全评估

✅ 安全配置
  - 密码哈希: bcrypt (安全)
  - 会话管理: 安全配置
  - HTTPS强制: 已启用

❌ 发现问题
  - 缺少密码复杂度检查
  - 未实施账户锁定机制
  - 缺少多因素认证

🔧 建议改进
  1. 添加密码复杂度验证
  2. 实施登录尝试限制
  3. 考虑添加2FA支持
  4. 实施会话超时机制
```

## 安全标准合规

### OWASP Top 10 检查
- A01: 访问控制失效
- A02: 加密机制失效
- A03: 注入攻击
- A04: 不安全设计
- A05: 安全配置错误
- A06: 易受攻击的组件
- A07: 身份认证失效
- A08: 软件数据完整性失效
- A09: 安全日志监控失效
- A10: 服务器端请求伪造

### 安全框架对照
- **ISO 27001**: 信息安全管理
- **NIST**: 网络安全框架
- **PCI DSS**: 支付卡行业标准
- **GDPR**: 数据保护合规

## 最佳实践

### 1. 定期扫描
- 每日自动扫描
- 版本发布前扫描
- 依赖项更新后扫描
- 代码变更后扫描

### 2. 风险管理
- 按优先级修复漏洞
- 建立风险接受流程
- 跟踪修复进度
- 验证修复效果

### 3. 安全文化
- 开发者安全培训
- 安全代码审查
- 安全测试自动化
- 事件响应计划

## 工具集成

### 扫描工具
- **SAST**: 静态应用安全测试
- **DAST**: 动态应用安全测试
- **依赖检查**: npm audit, Snyk
- **代码分析**: SonarQube, CodeQL

### 监控工具
- **实时监控**: 应用性能监控
- **日志分析**: 安全事件检测
- **威胁情报**: 最新威胁信息
- **合规报告**: 自动合规检查

## 相关命令

- [`m-review-code`](m-review-code.md) - 代码质量审查
- [`m-test-generation`](m-test-generation.md) - 安全测试生成
- [`m-project-cleanup`](m-project-cleanup.md) - 项目清理
- [`m-document-update`](m-document-update.md) - 安全文档更新
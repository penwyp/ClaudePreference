# 命令: m:bug-fix - 综合Bug修复工作流

## 概述

`m:bug-fix` 是一个全面的Bug分析、重现、识别、修复和验证工作流。该命令支持多种Bug源输入格式，包括问题编号、错误文本、截图、日志文件或问题描述，能够系统性地解决代码中的各类问题。

## 使用方法

```bash
/m:bug-fix [source]
```

## 参数详解

- `source` (可选): Bug源信息
  - 默认行为: 分析最近的错误日志和失败的测试
  - 支持格式:
    - 问题编号: `#123`
    - 错误文本: `"NullPointerException in login"`
    - 截图/图片: `screenshot.png`
    - 日志文件: `logs/error.log`
    - 问题描述: `"用户登录时出现超时"`

## 使用示例

### 基于问题编号修复
```bash
/m:bug-fix #123
```
**预期结果**: 
- 从GitHub/GitLab等平台获取问题详情
- 分析问题描述和复现步骤
- 定位相关代码区域
- 实施修复方案

### 基于错误文本修复
```bash
/m:bug-fix "NullPointerException in UserService.login()"
```
**预期结果**: 
- 解析错误信息
- 定位到 UserService.login() 方法
- 分析空指针异常原因
- 实施空值检查和处理

### 基于截图修复
```bash
/m:bug-fix screenshot.png
```
**预期结果**: 
- 分析截图中的错误信息
- 识别UI异常或错误提示
- 定位相关前端/后端代码
- 修复显示问题

### 基于日志文件修复
```bash
/m:bug-fix logs/error.log
```
**预期结果**: 
- 解析日志文件内容
- 识别错误模式和堆栈跟踪
- 定位问题根源
- 修复底层问题

### 默认分析模式
```bash
/m:bug-fix
```
**预期结果**: 
- 扫描最近的错误日志
- 检查失败的测试用例
- 识别潜在问题
- 提供修复建议

## 工作流程

### 1. 分析Bug源
- **问题解析**: 分析输入的问题、图片、文本或日志
- **上下文研究**: 使用 `context7` 搜索相关文档和解决方案
- **问题分类**: 确定Bug类型（逻辑错误、性能问题、UI异常等）

### 2. 重现问题
- **环境设置**: 准备测试环境
- **测试用例创建**: 编写重现Bug的测试用例
- **一致性验证**: 确保能够稳定重现问题

### 3. 识别根本原因
- **代码跟踪**: 追踪代码执行路径
- **堆栈分析**: 分析调用堆栈和错误位置
- **依赖检查**: 检查相关依赖和配置
- **数据流分析**: 追踪数据在系统中的流动

### 4. 实施修复
- **目标解决方案**: 应用最小副作用的修复
- **代码审查**: 确保修复不引入新问题
- **最佳实践**: 遵循项目编码规范
- **文档更新**: 记录修复过程和原因

### 5. 验证修复和测试
- **单元测试**: 验证修复的特定功能
- **集成测试**: 确保系统整体功能正常
- **回归测试**: 验证没有引入新问题
- **性能测试**: 检查修复对性能的影响

## Bug类型处理

### 空指针异常
```bash
/m:bug-fix "NullPointerException in payment processing"
```
**处理流程**:
1. 定位空指针发生位置
2. 分析数据流和对象生命周期
3. 添加空值检查
4. 实施防御性编程

### 内存泄漏
```bash
/m:bug-fix "Memory leak in data processing service"
```
**处理流程**:
1. 使用内存分析工具
2. 识别未释放的资源
3. 添加适当的清理代码
4. 实施资源管理最佳实践

### 并发问题
```bash
/m:bug-fix "Race condition in user session management"
```
**处理流程**:
1. 分析并发访问模式
2. 识别竞态条件
3. 实施同步机制
4. 添加线程安全检查

### 性能问题
```bash
/m:bug-fix "Query timeout in user dashboard"
```
**处理流程**:
1. 分析查询性能
2. 识别瓶颈
3. 优化查询逻辑
4. 添加缓存机制

## 预期结果

### 成功修复输出
```
🔍 Bug分析完成
  - 问题类型: NullPointerException
  - 影响范围: UserService.login()
  - 根本原因: 缺少输入参数验证

🔧 修复实施
  - 添加参数空值检查
  - 实施异常处理
  - 更新相关文档

✅ 验证通过
  - 单元测试: 15/15 通过
  - 集成测试: 8/8 通过
  - 回归测试: 无新问题

📋 修复摘要
  - 修复文件: src/services/UserService.java
  - 测试文件: tests/UserServiceTest.java
  - 提交消息: "fix: add null check in UserService.login()"
```

### 问题分析报告
```
📊 Bug分析报告
  - 问题ID: #123
  - 严重程度: 高
  - 影响用户: 登录用户
  - 复现率: 100%
  - 修复时间: 2小时

🔍 根本原因分析
  - 直接原因: 输入参数未验证
  - 根本原因: 缺少防御性编程
  - 预防措施: 添加输入验证框架

🛠️ 修复方案
  - 短期: 添加空值检查
  - 长期: 实施全局输入验证
  - 监控: 添加异常监控
```

## 错误处理

### 无法重现问题
```
⚠️ 无法重现问题
可能原因:
- 环境配置不同
- 数据状态变化
- 时间依赖性问题
建议: 收集更多上下文信息
```

### 修复验证失败
```
❌ 修复验证失败
- 3/15 单元测试失败
- 检测到回归问题
建议: 回滚修复，重新分析
```

## 最佳实践

### 1. 问题分析
- 收集完整的错误信息
- 记录重现步骤
- 分析影响范围
- 确定优先级

### 2. 修复实施
- 最小化更改范围
- 遵循编码规范
- 添加适当的测试
- 记录修复原因

### 3. 测试验证
- 编写针对性测试
- 执行回归测试
- 验证性能影响
- 检查边界情况

### 4. 文档记录
- 记录问题分析过程
- 文档化修复方案
- 更新相关文档
- 分享经验教训

## 工具集成

### 调试工具
- 调试器集成
- 日志分析工具
- 性能分析器
- 内存泄漏检测

### 测试工具
- 单元测试框架
- 集成测试工具
- 负载测试工具
- 自动化测试

## 相关命令

- [m:test-generation`](m-test-generation.md) - 生成测试用例
- [m:review-code`](m-review-code.md) - 代码审查
- [m:security-scan`](m-security-scan.md) - 安全扫描
- [m:commit-push`](m-commit-push.md) - 提交修复